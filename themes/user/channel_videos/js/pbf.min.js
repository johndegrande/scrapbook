!function(global,$){"use strict";function toggleSearchVideos(e){return $(e.target).closest(".CVTable").find(".SVWrapperTR").toggle(),!1}function disableEnter(e){if(13==e.which)return $(e.target).closest(".CVField").find(".searchbutton").click(),!1}function syncOrderNumbers(){var attr;fieldsElem.each(function(FieldIndex,VideoField){$(VideoField).find(".CVItem").each(function(VideoIndex,VideoItem){$(VideoItem).find("input, textarea, select").each(function(){attr=$(this).attr("name").replace(/\[videos\]\[.*?\]/,"[videos]["+(VideoIndex+1)+"]"),$(this).attr("name",attr)})}),$(VideoField).find(".CVItem").removeClass("odd"),$(VideoField).find(".CVItem:odd").addClass("odd")})}function delVideo(e){var VideoID=$(e.target).data("id");VideoID&&$.get(ChannelVideos.ACT_URL,{video_id:VideoID,ajax_method:"delete_video"},function(){}),$(e.target).closest(".CVItem").fadeOut("slow",function(){$(this).remove(),syncOrderNumbers()})}function clearVideoSearch(e){return jQuery(e.target).closest(".CVField").find(".VideosResults .inner").empty(),!1}function searchForVideos(e){e.preventDefault();var params={},customField=$(e.target).closest(".CVField"),videoServices=fields["field_"+customField.data("field_id")].services;customField.find(".SVWrapper .cvsearch").find("input[type=text], input[type=hidden]").each(function(){params[$(this).attr("rel")]=jQuery(this).val()});for(var i=0;i<videoServices.length;i++)customField.find(".VideosResults .results-"+videoServices[i]).show().find(".LoadingVideos").show().siblings(".inner").empty(),"youtube"==videoServices[i]?youtubeSearchVideos(params,customField):vimeoSearchVideos(params,customField)}function addVideoResults(service,items,customField){var html="";0===items.length&&(html+="<p>No Results Found...</p>");for(var i=0;i<items.length;i++)html+='<div class="video" rel="'+service+"|"+items[i].id+'" id="'+service+"__"+items[i].id+'">',html+='<img src="'+items[i].img_url+'" width="100px" height="75px">',html+="<small>"+items[i].title+"</small>",html+="<span>",html+='<a href="'+items[i].vid_url+'" class="play">&nbsp;</a>',html+='<a href="#" class="add">&nbsp;</a>',html+="</span>",html+="</div>";html+='<br clear="all"></div>',customField.find(".VideosResults .results-"+service).find(".LoadingVideos").hide().siblings(".inner").show().html(html),customField.find(".VideosResults .video .play").colorbox({iframe:!0,width:450,height:375})}function submitVideoUrl(e){var videoUrl=prompt("Video URL?","");if(null===videoUrl)return!1;var customField=$(e.target).closest("div.CVField"),videoServices=fields["field_"+customField.data("field_id")].services;customField.find(".SVWrapperTR").show();for(var i=0;i<videoServices.length;i++)customField.find(".VideosResults .results-"+videoServices[i]).show().find(".LoadingVideos").show().siblings(".inner").empty(),"youtube"==videoServices[i]?youtubeSubmitUrl(videoUrl,customField):vimeoSubmitUrl(videoUrl,customField);return!1}function addVideoToTable(video,field_id){var field_data=fields["field_"+field_id],customField=$("#ChannelVideos"+field_id),html="";customField.find("#"+video.service+"__"+video.service_video_id).slideUp();var video_date=new Date;video_date.setTime(1e3*video.video_date),"table"==field_data.layout?(html+='<tr class="CVItem">',html+='<td><a href="'+video.video_url+'" class="PlayVideo"><img src="'+video.video_img_url+'" width="100px" height="75px"></a></td>',html+="<td>"+video.video_title+"</td>",html+="<td>"+video.video_author+"</td>",html+="<td>"+(video.video_duration/60).toFixed(2)+" min</td>",html+="<td>"+video.video_views+"</td>",html+="<td>"+video_date.toDateString()+"</td>",html+="<td>",html+='<a href="javascript:void(0)" class="MoveVideo">&nbsp;</a>',html+='<a href="javascript:void(0)" class="DelVideo" data-id="'+video.video_id+'">&nbsp;</a>',video.video_id>0?html+='<input name="'+field_data.field_name+'[videos][0][video_id]" type="hidden" value="'+video.video_id+'">':html+='<textarea name="'+field_data.field_name+'[videos][0][data]" style="display:none">'+JSON.stringify(video)+"</textarea>",html+="</td>",html+="</tr>"):(html+='<div class="CVItem VideoTile">',html+='<a href="'+video.video_url+'" class="PlayVideo"><img src="'+video.video_img_url+'" width="100px" height="75px"></a>',html+="<small>"+video.video_title+"</small>",html+="<span>",html+='<a href="javascript:void(0)" class="MoveVideo">&nbsp;</a>',html+='<a href="javascript:void(0)" class="DelVideo" data-id="'+video.video_id+'">&nbsp;</a>',video.video_id>0?html+='<input name="'+field_data.field_name+'[videos][0][video_id]" type="hidden" value="'+video.video_id+'">':html+='<textarea name="'+field_data.field_name+'[videos][0][data]" style="display:none">'+JSON.stringify(video)+"</textarea>",html+="</span>",html+="</div>"),customField.find(".AssignedVideos .NoVideos").hide(),customField.find(".AssignedVideos").append(html),syncOrderNumbers(),customField.find(".AssignedVideos .CVItem .PlayVideo").colorbox({iframe:!0,width:450,height:375})}function addVideo(e){var Parent=jQuery(e.target).closest("div.video"),field_id=jQuery(e.target).closest("div.CVField").data("field_id"),video_id=Parent.attr("rel").split("|")[1],service=Parent.attr("rel").split("|")[0];return jQuery(e.target).addClass("loading"),"youtube"==service?(youtubeGetVideo(video_id,field_id,addVideoToTable),!1):(vimeoGetVideo(video_id,field_id,addVideoToTable),!1)}function youtubeSearchVideos(params,customField){params.author&&(params.keywords+=" "+params.author),$.ajax({crossDomain:!0,dataType:"json",type:"GET",url:"https://www.googleapis.com/youtube/v3/search",data:{q:params.keywords,maxResults:params.limit,type:"video",part:"snippet",key:youtubeKey},success:function(rdata){for(var videos=[],i=0;i<rdata.items.length;i++){var video=rdata.items[i],videoID=video.id.videoId;videos.push({id:videoID,title:video.snippet.title,img_url:"https://i.ytimg.com/vi/"+videoID+"/sddefault.jpg",vid_url:"https://www.youtube.com/embed/"+videoID})}addVideoResults("youtube",videos,customField)},error:function(error){var objx=JSON.parse(error.responseText);console.log(objx);var msg="Youtube error: - ";$.each(objx.error.errors,function(index,value){return msg+=value.message,!1}),alert(msg)}})}function youtubeSubmitUrl(url,customField){var parts,servicebox=customField.find(".VideosResults .results-youtube").show(),inner=servicebox.find(".inner"),loading=servicebox.find(".LoadingVideos"),id=null;return-1===url.indexOf("youtube")&&-1===url.indexOf("youtu.be")?(loading.hide(),void inner.html("<p>Not a valid Youtube URL</p>")):(url.indexOf("youtube.com/watch")>0?(parts=parseUrl(url),id=getQueryVariable(parts.query,"v")):url.indexOf("youtu.be")>0?(parts=url.split("/"),id=parts[parts.length-1]):url.indexOf("youtube.com/embed")>0&&(parts=url.split("/"),id=parts[parts.length-1]),null===id?(loading.hide(),void inner.html("<p>Could not parse Youtube ID from that URL</p>")):void $.ajax({crossDomain:!0,dataType:"json",type:"GET",url:"https://www.googleapis.com/youtube/v3/videos",data:{id:id,part:"snippet",key:youtubeKey},success:function(rdata){loading.hide(),void 0!==rdata.pageInfo&&1==typeof rdata.pageInfo.totalResults||inner.html("<p>Youtube could not find the video. (ID: "+id+")</p>");var video=rdata.items[0],videoId=video.id;addVideoResults("youtube",[{id:videoId,title:video.snippet.title,img_url:"https://i.ytimg.com/vi/"+videoId+"/sddefault.jpg",vid_url:"https://www.youtube.com/embed/"+videoId}],customField)}}))}function youtubeGetVideo(id,field_id,callback){$.ajax({crossDomain:!0,dataType:"json",type:"GET",url:"https://www.googleapis.com/youtube/v3/videos",data:{id:id,part:"snippet,statistics,contentDetails",key:youtubeKey},success:function(rdata){var videoID=id,video={},entry=rdata.items[0];video.service="youtube",video.service_video_id=videoID,video.video_id=0,video.video_url="https://www.youtube.com/embed/"+videoID,video.video_img_url="http://i.ytimg.com/vi/"+videoID+"/sddefault.jpg",video.video_title=entry.snippet.title,video.video_desc=entry.snippet.description,video.video_username=entry.snippet.channelTitle,video.video_author=entry.snippet.channelTitle,video.video_author_id=0,video.video_duration=nezasa.iso8601.Period.parseToTotalSeconds(entry.contentDetails.duration),video.video_date=new Date(entry.publishedAt).getTime()/1e3,video.video_views=0,void 0!==entry.statistics&&void 0!==entry.statistics.viewCount&&(video.video_views=entry.statistics.viewCount),callback(video,field_id)}})}function vimeoSearchVideos(params,customField){var servicebox=customField.find(".VideosResults .results-vimeo").show(),inner=servicebox.find(".inner"),loading=servicebox.find(".LoadingVideos");$.ajax({url:"https://api.vimeo.com/videos?query="+params.keywords+"&per_page="+params.limit+(params.author?"&user_id="+params.author:""),headers:{Authorization:"Bearer "+ChannelVideos.VIMEO_ACCESS_TOKEN},success:function(response){if(void 0===response.data)return loading.hide(),void inner.html("<p>The vimeo request failed!</p>");if(0===response.data.length)return loading.hide(),void inner.html("<p>No results found..</p>");for(var video_info,Videos=[],i=0;i<response.data.length;i++){for(var thumb,img_url,ii=(video_info=response.data[i]).pictures.sizes.length-1;ii>=0;ii--)if(100===(thumb=video_info.pictures.sizes[ii]).width){img_url=thumb.link;break}var video_id=video_info.uri.match(/(\d+)$/)[0];Videos.push({id:video_id,title:video_info.name,img_url:img_url,vid_url:"https://player.vimeo.com/video/"+video_id+"?title=0&byline=0&portrait=0"})}addVideoResults("vimeo",Videos,customField)},error:function(error){var objx=JSON.parse(error.responseText);alert("Vimeo error: - "+objx.error)}})}function vimeoSubmitUrl(url,customField){var parts,servicebox=customField.find(".VideosResults .results-vimeo").show(),inner=servicebox.find(".inner"),loading=servicebox.find(".LoadingVideos"),id=null;return-1===url.indexOf("vimeo")?(loading.hide(),void inner.html("<p>Not a valid Vimeo URL</p>")):(url.indexOf("vimeo.com/")>0&&(parts=url.split("/"),id=parts[parts.length-1]),null===id?(loading.hide(),void inner.html("<p>Could not parse Vimeo ID from that URL</p>")):void $.ajax({url:"https://api.vimeo.com/videos/"+id,headers:{Authorization:"Bearer "+ChannelVideos.VIMEO_ACCESS_TOKEN},success:function(video_info){if(void 0===video_info.name)return loading.hide(),void inner.html("<p>The vimeo request failed!</p>");for(var thumb,img_url,ii=video_info.pictures.sizes.length-1;ii>=0;ii--)if(100===(thumb=video_info.pictures.sizes[ii]).width){img_url=thumb.link;break}addVideoResults("vimeo",[{id:id,title:video_info.name,img_url:img_url,vid_url:"https://player.vimeo.com/video/"+id+"?title=0&byline=0&portrait=0"}],customField)},error:function(error){var objx=JSON.parse(error.responseText);alert("Vimeo error: - "+objx.error)}}))}function vimeoGetVideo(id,field_id,callback){$.ajax({url:"https://api.vimeo.com/videos/"+id,headers:{Authorization:"Bearer "+ChannelVideos.VIMEO_ACCESS_TOKEN},success:function(video_info){if(void 0===video_info.name)return loading.hide(),void inner.html("<p>The vimeo request failed!</p>");for(var thumb,img_url,ii=video_info.pictures.sizes.length-1;ii>=0;ii--)if(100===(thumb=video_info.pictures.sizes[ii]).width){img_url=thumb.link;break}var Video={service:"vimeo",service_video_id:id,video_id:0,video_url:"https://player.vimeo.com/video/"+id+"?title=0&byline=0&portrait=0",video_img_url:img_url,video_title:video_info.name,video_desc:video_info.description,video_username:video_info.user.name,video_author:video_info.user.name,video_author_id:0,video_duration:video_info.duration,video_views:video_info.stats.plays,video_date:new Date(video_info.created_time.replace(" ","T")+"-00:00").getTime()/1e3};callback(Video,field_id)},error:function(error){alert("Invalid request for Vimeo videos. Please insert the correct access token in player settings")}})}function parseUrl(str,component){for(var key=["source","scheme","authority","userInfo","user","pass","host","port","relative","path","directory","file","query","fragment"],ini={},mode=ini["phpjs.parse_url.mode"]&&ini["phpjs.parse_url.mode"].local_value||"php",parser={php:/^(?:([^:\/?#]+):)?(?:\/\/()(?:(?:()(?:([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?()(?:(()(?:(?:[^?#\/]*\/)*)()(?:[^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/\/?)?((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/},m=parser[mode].exec(str),uri={},i=14;i--;)m[i]&&(uri[key[i]]=m[i]);if(component)return uri[component.replace("PHP_URL_","").toLowerCase()];if("php"!==mode){var name=ini["phpjs.parse_url.queryKey"]&&ini["phpjs.parse_url.queryKey"].local_value||"queryKey";parser=/(?:^|&)([^&=]*)=?([^&]*)/g,uri[name]={},uri[key[12]].replace(parser,function($0,$1,$2){$1&&(uri[name][$1]=$2)})}return delete uri.source,uri}function getQueryVariable(url,variable){for(var vars=url.split("&"),i=0;i<vars.length;i++){var pair=vars[i].split("=");if(decodeURIComponent(pair[0])==variable)return decodeURIComponent(pair[1])}return null}var fieldsElem,ChannelVideos=global.ChannelVideos=global.ChannelVideos||{},fields={},youtubeKey="";ChannelVideos.Init=function(){if(""==EE.youtubeKey)return alert("Please set the YouTube API key"),!1;youtubeKey=EE.youtubeKey,(fieldsElem=$(".CVField")).each(function(i,elem){elem=$(elem),fields["field_"+elem.data("field_id")]=JSON.parse(elem.find(".jsondata").html())}),fieldsElem.find(".SearchVideos").click(toggleSearchVideos),fieldsElem.find(".SearchVideos input[type=text]").keypress(disableEnter),fieldsElem.find(".SVWrapper .Button").click(searchForVideos),fieldsElem.find(".SubmitVideoUrl").click(submitVideoUrl),fieldsElem.delegate(".VideosResults .video .add","click",addVideo),fieldsElem.delegate(".DelVideo","click",delVideo),fieldsElem.delegate(".ClearVideoSearch","click",clearVideoSearch),fieldsElem.find(".AssignedVideos").sortable({cursor:"move",opacity:.6,handle:".MoveVideo",update:syncOrderNumbers,helper:function(event,ui){return ui.children().each(function(){$(this).width($(this).width())}),ui},forcePlaceholderSize:!0,start:function(event,ui){ui.placeholder.html('<td colspan="20"></td>')},placeholder:"cvideo-reorder-state-highlight"}),fieldsElem.find(".AssignedVideos .CVItem .PlayVideo").colorbox({iframe:!0,width:450,height:375})}}(window,jQuery),function(nezasa,undefined){function parsePeriodString(period,_distributeOverflow){var struct,distributeOverflow=_distributeOverflow||!1,valueIndexes=[2,3,4,5,7,8,9],duration=[0,0,0,0,0,0,0],overflowLimits=[0,12,4,7,24,60,60];if(!(period=period.toUpperCase()))return duration;if("string"!=typeof period)throw new Error("Invalid iso8601 period string '"+period+"'");if(!(struct=/^P((\d+Y)?(\d+M)?(\d+W)?(\d+D)?)?(T(\d+H)?(\d+M)?(\d+S)?)?$/.exec(period)))throw new Error("String '"+period+"' is not a valid ISO8601 period.");for(i=0;i<valueIndexes.length;i++){var structIndex=valueIndexes[i];duration[i]=struct[structIndex]?+struct[structIndex].replace(/[A-Za-z]+/g,""):0}if(distributeOverflow)for(var i=duration.length-1;i>0;i--)duration[i]>=overflowLimits[i]&&(duration[i-1]=duration[i-1]+Math.floor(duration[i]/overflowLimits[i]),duration[i]=duration[i]%overflowLimits[i]);return duration}nezasa.iso8601||(nezasa.iso8601={}),nezasa.iso8601.Period||(nezasa.iso8601.Period={}),nezasa.iso8601.version="0.2",nezasa.iso8601.Period.parse=function(period,distributeOverflow){return parsePeriodString(period,distributeOverflow)},nezasa.iso8601.Period.parseToTotalSeconds=function(period){for(var multiplicators=[31104e3,2592e3,604800,86400,3600,60,1],durationPerUnit=parsePeriodString(period),durationInSeconds=0,i=0;i<durationPerUnit.length;i++)durationInSeconds+=durationPerUnit[i]*multiplicators[i];return durationInSeconds},nezasa.iso8601.Period.isValid=function(period){try{return parsePeriodString(period),!0}catch(e){return!1}},nezasa.iso8601.Period.parseToString=function(period,unitNames,unitNamesPlural,distributeOverflow){var result=["","","","","","",""],durationPerUnit=parsePeriodString(period,distributeOverflow);unitNames||(unitNames=["year","month","week","day","hour","minute","second"]),unitNamesPlural||(unitNamesPlural=["years","months","weeks","days","hours","minutes","seconds"]);for(var i=0;i<durationPerUnit.length;i++)durationPerUnit[i]>0&&(1==durationPerUnit[i]?result[i]=durationPerUnit[i]+" "+unitNames[i]:result[i]=durationPerUnit[i]+" "+unitNamesPlural[i]);return result.join(" ").trim().replace(/[ ]{2,}/g," ")}}(window.nezasa=window.nezasa||{}),$(document).ready(function(){youtubeKey=EE.youtubeKey,ChannelVideos.Init()});